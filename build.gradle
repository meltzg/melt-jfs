/*
 * This file was generated by the Gradle "init" task.
 *
 * This generated file contains a sample Java Library project to get you started.
 * For more details take a look at the Java Libraries chapter in the Gradle
 * User Manual available at https://docs.gradle.org/6.6.1/userguide/java_library_plugin.html
 */

plugins {
    // Apply the java-library plugin to add support for Java Library
    id "java-library"
    id "cpp"
    id "io.freefair.lombok" version "5.2.1"
}

repositories {
    // You can declare any Maven/Ivy/file repository here.
    mavenCentral()
}

dependencies {
    // Use JUnit test framework
    testImplementation "junit:junit:4.13"
}

ext {
    javaHome = System.getenv("JAVA_HOME")
    javaHomeInclude = javaHome + "/include"
    if (System.properties["os.name"].toLowerCase().contains("linux")) {
        javaHomeIncludeOs = javaHomeInclude + "/linux"
    } else {
        javaHomeIncludeOs = javaHomeInclude + "/win32"
    }

    println javaHome
}

compileJava {
    options.compilerArgs += ["-h", file("src/main/cpp/headers/")]
}

test {
    systemProperty "java.library.path", file("${buildDir}/libs/jmtp/shared").absolutePath
    dependsOn "jmtpSharedLibrary"
}

model {
    toolChains {
        gcc(Gcc) {
            eachPlatform {
                cCompiler.withArguments { args ->
                    args << "-std=c++11"
                    args << "-g"
                    args << "-Wall"
                    args << "-Werror"
                }
            }
        }
    }
    repositories {
        libs(PrebuiltLibraries) {
            mtp {
                headers.srcDir "/usr/include"
            }

            def libDir = "/usr/lib/x86_64-linux-gnu/"

            mtplib {
                binaries.withType(SharedLibraryBinary) {
                    sharedLibraryFile = file(libDir + "libmtp.so")
                }
            }
        }
    }
    components {
        jmtp(NativeLibrarySpec) {
            sources {
                cpp {
                    source {
                        srcDir "src/main/cpp/src"
                        include "*.cpp"
                    }
                    exportedHeaders {
                        srcDirs "src/main/cpp/headers", "/usr/include", "/usr/local/include", javaHomeInclude, javaHomeIncludeOs
                    }

                    lib library: "mtp", linkage: "api"
                    lib library: "mtplib"
                }

            }
        }
    }
}
